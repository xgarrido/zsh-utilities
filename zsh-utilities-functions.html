<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Zsh Utilities Functions</title>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Xavier Garrido" />
<link rel="stylesheet" href="css/styles.css" />
               <link rel="stylesheet" href="css/org-pygments.css" />
               <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script><script type="text/javascript">
  function randomLinkColor() {
      var colors = ['#f1c40f','#e74c3c','#3399cc','#e67e22','#67ad00','#8e44ad','#1abc9c','#003399'];
      var random_color = colors[Math.floor(Math.random() * colors.length)];
      var elements = document.querySelectorAll('a');
      [].slice.call(elements).forEach(function(elem) {
          //elem.style.color = random_color;
      });
  }
  function displayTOC() {
      var ttoc = document.getElementById("text-table-of-contents");
      if (ttoc) {
          var maincontent = '<a class="button"><i class="fa fa-list"></i></a>'
          maincontent += "<div>" + ttoc.innerHTML + "</div>";
          document.getElementById("toc").innerHTML = maincontent;
      } else {
          document.getElementById("toc").style.display = "none";
          document.getElementById("preamble").style.top = "10px";
      }
     }
  </script>
</head>
<body onload="randomLinkColor();displayTOC();"><div id="toc"></div>
<div id="preamble" class="status">
 <a href="https://github.com/xgarrido/zsh-utilities"><i class="fa fa-github"></i></a><br/> 
</div>
<div id="content">
<h1 class="title">Zsh Utilities Functions</h1>
<p>
This is part of the <a href="zsh-utilities.html">Zsh Utilities</a>.
</p>

<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">Zsh Utilities - Functions</h2>
<div class="outline-text-2" id="text-unnumbered-1">
<p>
This file provides several functions for very different use. See the description
to understand the aim of each of them.
</p>
</div>

<div id="outline-container-unnumbered-2" class="outline-3">
<h3 id="unnumbered-2">Package manager</h3>
<div class="outline-text-3" id="text-unnumbered-2">
<p>
This part defines some function in relation with package management. It defines
generic function name given the linux system installed : "debian-like" system or
<a href="https://www.archlinux.org/">archlinux</a>.
</p>
</div>

<div id="outline-container-unnumbered-3" class="outline-4">
<h4 id="unnumbered-3">Check linux system</h4>
<div class="outline-text-4" id="text-unnumbered-3">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">__is_debian</span> ()
{
    <span class="org-keyword">if</span> pkgtools__has_binary apt-fast; <span class="org-keyword">then</span>
        <span class="org-variable-name">__pkg_mgr</span>=<span class="org-string">"apt-fast"</span>
        <span class="org-keyword">return</span> 0
    <span class="org-keyword">elif</span> pkgtools__has_binary apt-get; <span class="org-keyword">then</span>
        <span class="org-variable-name">__pkg_mgr</span>=<span class="org-string">"apt-get"</span>
        <span class="org-keyword">return</span> 0
    <span class="org-keyword">elif</span> pkgtools__has_binary yaourt; <span class="org-keyword">then</span>
        <span class="org-variable-name">__pkg_mgr</span>=<span class="org-string">"yaourt"</span>
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">elif</span> pkgtools__has_binary pacman; <span class="org-keyword">then</span>
        <span class="org-variable-name">__pkg_mgr</span>=<span class="org-string">"pacman"</span>
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-4" class="outline-4">
<h4 id="unnumbered-4">Implement generic function</h4>
<div class="outline-text-4" id="text-unnumbered-4">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-builtin">alias</span> pkg-notify=<span class="org-string">'notify -t 2000 -i stock_dialog-info "${__pkg_mgr}"'</span>
<span class="org-keyword">if</span> __is_debian; <span class="org-keyword">then</span>

    <span class="org-keyword">function</span> <span class="org-function-name">install</span> ()
    {
        __pkgtools__at_function_enter install
        sudo ${<span class="org-variable-name">__pkg_mgr</span>} install -y $<span class="org-variable-name">*</span> &amp;&amp; pkg-notify <span class="org-string">"Installed $@"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }
    compdef <span class="org-string">"_deb_packages uninstalled"</span> install

    <span class="org-keyword">function</span> <span class="org-function-name">remove</span> ()
    {
        __pkgtools__at_function_enter remove
        sudo ${<span class="org-variable-name">__pkg_mgr</span>} remove -y $<span class="org-variable-name">*</span> &amp;&amp; pkg-notify <span class="org-string">"Removed $@"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }
    compdef <span class="org-string">"_deb_packages installed"</span> remove

    <span class="org-keyword">function</span> <span class="org-function-name">upgrade</span> ()
    {
        __pkgtools__at_function_enter upgrade
        sudo ${<span class="org-variable-name">__pkg_mgr</span>} update &amp;&amp; sudo ${<span class="org-variable-name">__pkg_mgr</span>} upgrade &amp;&amp; pkg-notify <span class="org-string">"Upgrade done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">search</span> ()
    {
        __pkgtools__at_function_enter search
        apt-cache search $<span class="org-variable-name">@</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">purge</span> ()
    {
        __pkgtools__at_function_enter purge
        sudo ${<span class="org-variable-name">__pkg_mgr</span>} purge &amp;&amp; pkg-notify <span class="org-string">"Purge done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">distupgrade</span> ()
    {
        __pkgtools__at_function_enter distupgrade
        sudo ${<span class="org-variable-name">__pkg_mgr</span>} update &amp;&amp; sudo ${<span class="org-variable-name">__pkg_mgr</span>} dist-upgrade &amp;&amp; pkg-notify <span class="org-string">"Distribution upgrade done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">autoremove</span> ()
    {
        __pkgtools__at_function_enter autoremove
        sudo ${<span class="org-variable-name">__pkg_mgr</span>} autoremove &amp;&amp; pkg-notify <span class="org-string">"Autoremove done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }
<span class="org-keyword">else</span>
    <span class="org-keyword">function</span> <span class="org-function-name">upgrade</span> ()
    {
        __pkgtools__at_function_enter upgrade
        ${<span class="org-variable-name">__pkg_mgr</span>} -Suy &amp;&amp; pkg-notify <span class="org-string">"Upgrade done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">upgrade-aur</span> ()
    {
        __pkgtools__at_function_enter upgrade-aur
        ${<span class="org-variable-name">__pkg_mgr</span>} -Suya --devel &amp;&amp; pkg-notify <span class="org-string">"Upgrade done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">search</span> ()
    {
        __pkgtools__at_function_enter search
        ${<span class="org-variable-name">__pkg_mgr</span>} -Ss $<span class="org-variable-name">@</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }

    <span class="org-keyword">function</span> <span class="org-function-name">purge</span> ()
    {
        __pkgtools__at_function_enter purge
        ${<span class="org-variable-name">__pkg_mgr</span>} -Qdt &amp;&amp; pkg-notify <span class="org-string">"Purge done"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 0
    }
<span class="org-keyword">fi</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-5" class="outline-3">
<h3 id="unnumbered-5">Extract archive</h3>
<div class="outline-text-3" id="text-unnumbered-5">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">extract</span> ()
{
    __pkgtools__at_function_enter extract
    <span class="org-builtin">local</span> remove_archive
    <span class="org-builtin">local</span> success
    <span class="org-builtin">local</span> file_name
    <span class="org-builtin">local</span> extract_dir

    <span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">""</span> ]]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Usage: extract [-option] [file ...]"</span>
        <span class="org-builtin">echo</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Options:"</span>
        <span class="org-builtin">echo</span> <span class="org-string">"    -r, --remove : Remove archive."</span>
        <span class="org-builtin">echo</span>
    <span class="org-keyword">fi</span>

    <span class="org-variable-name">remove_archive</span>=1
    <span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"-r"</span> ]] || [[ <span class="org-string">"$1"</span> == <span class="org-string">"--remove"</span> ]]; <span class="org-keyword">then</span>
        <span class="org-variable-name">remove_archive</span>=0
        <span class="org-builtin">shift</span>
    <span class="org-keyword">fi</span>

    <span class="org-keyword">while</span> [ -n <span class="org-string">"$1"</span> ]; <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -f <span class="org-string">"$1"</span> ]]; <span class="org-keyword">then</span>
            pkgtools__msg_warning <span class="org-string">"'$1' is not a valid file"</span>
            <span class="org-builtin">shift</span>
            <span class="org-keyword">continue</span>
        <span class="org-keyword">fi</span>

        <span class="org-variable-name">success</span>=0
        <span class="org-variable-name">file_name</span>=<span class="org-string">"$( basename "$1" )"</span>
        <span class="org-variable-name">extract_dir</span>=<span class="org-string">"$( echo "$file_name" | sed "s/\.${1##*.}//g" )"</span>
        <span class="org-keyword">case</span> <span class="org-string">"$1"</span><span class="org-keyword"> in</span>
            (*.tar.gz|*.tgz) tar xvzf <span class="org-string">"$1"</span> ;;
            (*.tar.bz2|*.tbz|*.tbz2) tar xvjf <span class="org-string">"$1"</span> ;;
            (*.tar.xz|*.txz) tar --xz --help &amp;&gt; /dev/null <span class="org-sh-escaped-newline">\</span>
                &amp;&amp; tar --xz -xvf <span class="org-string">"$1"</span> <span class="org-sh-escaped-newline">\</span>
                || xzcat <span class="org-string">"$1"</span> | tar xvf - ;;
            (*.tar.zma|*.tlz) tar --lzma --help &amp;&gt; /dev/null <span class="org-sh-escaped-newline">\</span>
                &amp;&amp; tar --lzma -xvf <span class="org-string">"$1"</span> <span class="org-sh-escaped-newline">\</span>
                || lzcat <span class="org-string">"$1"</span> | tar xvf - ;;
            (*.tar) tar xvf <span class="org-string">"$1"</span> ;;
            (*.gz) gunzip <span class="org-string">"$1"</span> ;;
            (*.bz2) bunzip2 <span class="org-string">"$1"</span> ;;
            (*.xz) unxz <span class="org-string">"$1"</span> ;;
            (*.lzma) unlzma <span class="org-string">"$1"</span> ;;
            (*.Z) uncompress <span class="org-string">"$1"</span> ;;
            (*.zip) unzip <span class="org-string">"$1"</span> -d $<span class="org-variable-name">extract_dir</span> ;;
            (*.rar) unrar e -ad <span class="org-string">"$1"</span> ;;
            (*.7z) 7za x <span class="org-string">"$1"</span> ;;
            (*.deb)
                mkdir -p <span class="org-string">"$extract_dir/control"</span>
                mkdir -p <span class="org-string">"$extract_dir/data"</span>
                <span class="org-builtin">cd</span> <span class="org-string">"$extract_dir"</span>; ar vx <span class="org-string">"../${1}"</span> &gt; /dev/null
                <span class="org-builtin">cd</span> control; tar xzvf ../control.tar.gz
                <span class="org-builtin">cd</span> ../data; tar xzvf ../data.tar.gz
                <span class="org-builtin">cd</span> ..; rm *.tar.gz debian-binary
                <span class="org-builtin">cd</span> ..
                ;;
            (*)
                pkgtools__msg_error <span class="org-string">"'$1' cannot be extracted"</span> 1&gt;&amp;2
                <span class="org-variable-name">success</span>=1
                ;;
        <span class="org-keyword">esac</span>

        (( <span class="org-variable-name">success</span> = $<span class="org-variable-name">success</span> &gt; 0 ? $<span class="org-variable-name">success</span> : $<span class="org-variable-name">?</span> ))
        (( $<span class="org-variable-name">success</span> == 0 )) &amp;&amp; (( $<span class="org-variable-name">remove_archive</span> == 0 )) &amp;&amp; rm <span class="org-string">"$1"</span>
        <span class="org-builtin">shift</span>
    <span class="org-keyword">done</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-6" class="outline-3">
<h3 id="unnumbered-6">Notification</h3>
<div class="outline-text-3" id="text-unnumbered-6">
<p>
Base function for notification
</p>
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">notify</span> ()
{
    <span class="org-keyword">if</span> pkgtools__has_binary notify-send; <span class="org-keyword">then</span>
        <span class="org-keyword">if</span> [ <span class="org-string">"$HOSTNAME"</span> = <span class="org-string">"garrido-laptop"</span> ]; <span class="org-keyword">then</span>
            notify-send $<span class="org-variable-name">@</span> &gt; /dev/null 2&gt;&amp;1
        <span class="org-keyword">fi</span>
    <span class="org-keyword">fi</span>
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
<div id="outline-container-unnumbered-7" class="outline-4">
<h4 id="unnumbered-7">Success</h4>
<div class="outline-text-4" id="text-unnumbered-7">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">notify_success</span> ()
{
    __pkgtools__at_function_enter notify_success
    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
        notify -t 2000 -i stock_dialog-info <span class="org-string">"Notice"</span> <span class="org-string">"${PREEXEC_CMD:-Shell Command}"</span>
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-8" class="outline-4">
<h4 id="unnumbered-8">Error</h4>
<div class="outline-text-4" id="text-unnumbered-8">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">notify_error</span> ()
{
    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -ne 0 ]; <span class="org-keyword">then</span>
        notify -t 2000 -i stock_dialog-error <span class="org-string">" "</span> <span class="org-string">"${PREEXEC_CMD:-Shell Command} $@"</span>
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-9" class="outline-4">
<h4 id="unnumbered-9">Warning</h4>
<div class="outline-text-4" id="text-unnumbered-9">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">notify_warning</span> ()
{
    notify -t 3000 -i stock_dialog-warning <span class="org-string">" "</span> <span class="org-string">"${PREEXEC_CMD:-Shell Command} $@"</span>
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-10" class="outline-3">
<h3 id="unnumbered-10">Zsh <code>precmd</code> and <code>preexec</code></h3>
<div class="outline-text-3" id="text-unnumbered-10">
<p>
These two functions are only available for <code>zsh</code> shell. There are run at every
shell command and trigger notification events in case of long time command or
failling ones. This is pretty useful when long command such as compilation
command are running : user can go to another desktop do whatever he wants but
get warned when the command has finished or has failed.
</p>
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">precmd</span> ()
{
    <span class="org-comment-delimiter"># </span><span class="org-comment">must be first</span>
    notify_error

    <span class="org-comment-delimiter"># </span><span class="org-comment">BEGIN notify long running cmds</span>
    <span class="org-variable-name">stop</span>=$(date +<span class="org-string">'%s'</span>)
    <span class="org-variable-name">start</span>=${<span class="org-variable-name">PREEXEC_TIME</span>:-$<span class="org-variable-name">stop</span>}
    <span class="org-builtin">let</span> <span class="org-variable-name">elapsed</span>=$<span class="org-variable-name">stop</span>-$<span class="org-variable-name">start</span>
    <span class="org-variable-name">max</span>=${<span class="org-variable-name">PREEXEC_MAX</span>:-10}

    <span class="org-keyword">for</span> i<span class="org-keyword"> in</span> ${<span class="org-variable-name">PREEXEC_EXCLUDE_LIST</span>:-}; <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [ <span class="org-string">"x$i"</span> = <span class="org-string">"x$PREEXEC_CMD"</span> ]; <span class="org-keyword">then</span>
            <span class="org-variable-name">max</span>=999999;
            <span class="org-keyword">break</span>;
        <span class="org-keyword">fi</span>
    <span class="org-keyword">done</span>

    <span class="org-keyword">if</span> [ $<span class="org-variable-name">elapsed</span> -gt $<span class="org-variable-name">max</span> ]; <span class="org-keyword">then</span>
        notify_warning <span class="org-string">"finished ($elapsed secs)"</span>
    <span class="org-keyword">fi</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">END notify long running cmds</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Update scheme color</span>
    <span class="org-keyword">if</span> (( $+functions[__load_scheme] )); <span class="org-keyword">then</span>
        __load_scheme
    <span class="org-keyword">fi</span>

    <span class="org-keyword">return</span> 0
}

<span class="org-keyword">function</span> <span class="org-function-name">preexec</span> ()
{
    <span class="org-keyword">if</span> [[ <span class="org-string">"$TERM"</span> == <span class="org-string">"screen"</span> ]]; <span class="org-keyword">then</span>
        <span class="org-builtin">local</span> <span class="org-variable-name">CMD</span>=${<span class="org-variable-name">1</span>}
        <span class="org-builtin">echo</span> -ne <span class="org-string">"\ek$CMD\e\\"</span>
    <span class="org-keyword">fi</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">for notifying of long running commands</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">PREEXEC_CMD</span>=<span class="org-sh-quoted-exec">`echo $1 | awk '{ print $1; }'`</span>
    <span class="org-builtin">export</span> <span class="org-variable-name">PREEXEC_TIME</span>=$(date +<span class="org-string">'%s'</span>)
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-11" class="outline-3">
<h3 id="unnumbered-11">SSH connection</h3>
<div class="outline-text-3" id="text-unnumbered-11">
<p>
This should be improved by doing something as wakeonlan did with a small machine
db.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">connect</span> ()
{
    __pkgtools__at_function_enter connect
    <span class="org-builtin">local</span> <span class="org-variable-name">use_screen</span>=0
    <span class="org-builtin">local</span> <span class="org-variable-name">server_name</span>=
    <span class="org-builtin">local</span> <span class="org-variable-name">ssh_option</span>=
    <span class="org-builtin">local</span> <span class="org-variable-name">append_command</span>=

    <span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">""</span> ]]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Missing the name of machine to connect !"</span>
        <span class="org-builtin">echo</span> <span class="org-string">""</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>

    <span class="org-keyword">while</span> [ -n <span class="org-string">"$1"</span> ]; <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"-s"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">use_screen</span>=1
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"fzk"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">ssh_option</span>=<span class="org-string">"-p 24"</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"augerlogin.fzk.de"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"cern"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"xgarrido@lxplus.cern.ch"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"lyon"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@ccage.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">1</span> == ccige* ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@$1.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">1</span> == ccage* ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@$1.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"ovh"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">ssh_option</span>=<span class="org-string">"-p 1234"</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@r17187.ovh.net"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"laptop"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@nb-nemo6.lal.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"mac"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">ssh_option</span>=<span class="org-string">"-p 24"</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@xgarrido.dyndns.org"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"syno"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@xgarrido.synology.me"</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">elif [[ "$1" == "debian" ]]; then</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">server_name="debian@xgarrido.dyndns.org"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"lx3"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@lx3.lal.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"daq-nemo"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"bipolal@pc-nemo12.lal.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">"daq-lsm"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"nemoacq@lsmlx5.in2p3.fr"</span>
        <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">1</span> == pc-nemo* ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"nemo@$1"</span>
        <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">1</span> == pc-91089 ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@$1"</span>
        <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">1</span> == nemo* ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">server_name</span>=<span class="org-string">"garrido@$1.lal.in2p3.fr"</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">else</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">if [ "${HOSTNAME}" = "garrido-laptop" ]; then</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">server_name="garrido@localhost"</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">if [ -f /tmp/npu.d/ports ]; then</span>
            <span class="org-comment-delimiter">#             </span><span class="org-comment">ssh_port=$(cat /tmp/npu.d/ports | grep $1 | cut -d' ' -f2)</span>
            <span class="org-comment-delimiter">#             </span><span class="org-comment">ssh_option="-p ${ssh_port}"</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">else</span>
            <span class="org-comment-delimiter">#             </span><span class="org-comment">append_command+="$1 "</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">fi</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">else</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">if [[ "$1" == "pc" ]]; then</span>
            <span class="org-comment-delimiter">#             </span><span class="org-comment">server_name="pc-91089.lal.in2p3.fr"</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">else</span>
            <span class="org-comment-delimiter">#             </span><span class="org-comment">server_name="$1.lal.in2p3.fr"</span>
            <span class="org-comment-delimiter">#         </span><span class="org-comment">fi</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">fi</span>
        <span class="org-keyword">fi</span>
        <span class="org-builtin">shift</span> 1
    <span class="org-keyword">done</span>

    <span class="org-keyword">if</span> [ ${<span class="org-variable-name">use_screen</span>} -eq 0 ]; <span class="org-keyword">then</span>
        pkgtools__msg_notice <span class="org-string">"Connecting to ${server_name}..."</span>
        ssh -Y ${<span class="org-variable-name">ssh_option</span>} ${<span class="org-variable-name">server_name</span>} <span class="org-string">"${append_command}"</span>
    <span class="org-keyword">else</span>
        pkgtools__msg_notice <span class="org-string">"Connecting to ${server_name} with screen support..."</span>
        screen ssh -Y ${<span class="org-variable-name">ssh_option</span>} ${<span class="org-variable-name">server_name</span>}
    <span class="org-keyword">fi</span>

    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
<span class="org-comment-delimiter"># </span><span class="org-comment">Connect completion system</span>
compdef _connect connect

<span class="org-keyword">function</span> <span class="org-function-name">_connect</span> ()
{
    <span class="org-builtin">local</span> -a _machines
    <span class="org-variable-name">_machines</span>=(
        ccage:<span class="org-string">'CC Lyon job machines'</span>
        ccige:<span class="org-string">'CC Lyon interactive machines'</span>
        laptop:<span class="org-string">'Laptop machine'</span>
        mac:<span class="org-string">'iMac machine'</span>
        syno:<span class="org-string">'Synology server @ home'</span>
        lx3:<span class="org-string">'lxplus machine @ LAL'</span>
        nemo3:<span class="org-string">'nemo3 machine @ LAL'</span>
        nemo4:<span class="org-string">'nemo4 machine @ LAL'</span>
        pc-91089:<span class="org-string">'PC server machine @ LAL'</span>
        pc-nemo4:<span class="org-string">'V. Treytak machine'</span>
        pc-nemo5:<span class="org-string">'H. Gomez machine'</span>
        pc-nemo6:<span class="org-string">'Student machine'</span>
        pc-nemo8:<span class="org-string">'G. Eurin machine'</span>
    )
    _describe -t _machines <span class="org-string">'SSH machines'</span> _machines &amp;&amp; <span class="org-variable-name">ret</span>=0
}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-12" class="outline-3">
<h3 id="unnumbered-12">Grepping information</h3>
<div class="outline-text-3" id="text-unnumbered-12">
</div><div id="outline-container-unnumbered-13" class="outline-4">
<h4 id="unnumbered-13">Find a running job</h4>
<div class="outline-text-4" id="text-unnumbered-13">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">psgrep</span> ()
{
    __pkgtools__at_function_enter psgrep
    <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -z $<span class="org-variable-name">1</span> ]] ; <span class="org-keyword">then</span>
        pkgtools__msg_notice <span class="org-string">"Grepping for processes matching $1..."</span>
        ps aux | grep $<span class="org-variable-name">1</span> | grep -v grep
    <span class="org-keyword">else</span>
        pkgtools__msg_error <span class="org-string">"Need name to grep for !"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-14" class="outline-4">
<h4 id="unnumbered-14">Find a running job &amp; kill it</h4>
<div class="outline-text-4" id="text-unnumbered-14">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">pskill</span> ()
{
    __pkgtools__at_function_enter pskill
    psgrep $<span class="org-variable-name">1</span> | awk <span class="org-string">'{print "kill -9",$2}'</span> | sh
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-15" class="outline-4">
<h4 id="unnumbered-15">Find a command within history</h4>
<div class="outline-text-4" id="text-unnumbered-15">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">hgrep</span> ()
{
    __pkgtools__at_function_enter hgrep
    <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -z $<span class="org-variable-name">1</span> ]] ; <span class="org-keyword">then</span>
        pkgtools__msg_notice <span class="org-string">"Grepping for command matching $1..."</span>
        <span class="org-builtin">history</span> | grep $<span class="org-variable-name">1</span>
    <span class="org-keyword">else</span>
        pkgtools__msg_error <span class="org-string">"Need name to grep for !"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-16" class="outline-3">
<h3 id="unnumbered-16">Text edition</h3>
<div class="outline-text-3" id="text-unnumbered-16">
</div><div id="outline-container-unnumbered-17" class="outline-4">
<h4 id="unnumbered-17">Remove all trailing whitespace in a given file</h4>
<div class="outline-text-4" id="text-unnumbered-17">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">remove_trailing_whitespace</span> ()
{
    __pkgtools__at_function_enter remove_trailing_whitespace
    <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -z $<span class="org-variable-name">1</span> ]] ; <span class="org-keyword">then</span>
        pkgtools__msg_notice <span class="org-string">"Removing trailing whitespace in file $1..."</span>
        find $<span class="org-variable-name">1</span> -type f -exec sed -i <span class="org-string">'s/ *$//'</span> <span class="org-string">'{}'</span> <span class="org-string">';'</span>
    <span class="org-keyword">else</span>
        pkgtools__msg_error <span class="org-string">"Missing filename !"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-18" class="outline-4">
<h4 id="unnumbered-18">Remove duplicate lines</h4>
<div class="outline-text-4" id="text-unnumbered-18">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">remove_duplicate_lines</span> ()
{
    __pkgtools__at_function_enter remove_duplicate_lines
    <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -z $<span class="org-variable-name">1</span> ]] ; <span class="org-keyword">then</span>
        pkgtools__msg_notice <span class="org-string">"Removing duplicate lines in file $1..."</span>
        awk <span class="org-string">'!seen[$0]++'</span> $<span class="org-variable-name">1</span> &gt; /tmp/$(basename $<span class="org-variable-name">1</span>).tmp
        mv /tmp/$(basename $<span class="org-variable-name">1</span>).tmp $<span class="org-variable-name">1</span>
    <span class="org-keyword">else</span>
        pkgtools__msg_error <span class="org-string">"Missing filename !"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-unnumbered-19" class="outline-3">
<h3 id="unnumbered-19">Image edition</h3>
<div class="outline-text-3" id="text-unnumbered-19">
</div><div id="outline-container-unnumbered-20" class="outline-4">
<h4 id="unnumbered-20">Convert an EPS figure into tikz</h4>
<div class="outline-text-4" id="text-unnumbered-20">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">eps2tikz</span> ()
{
    __pkgtools__at_function_enter eps2tikz
    <span class="org-builtin">local</span> <span class="org-variable-name">use_helvetica</span>=0
    <span class="org-builtin">local</span> <span class="org-variable-name">keep_xfig</span>=0
    <span class="org-builtin">local</span> <span class="org-variable-name">remove_duplicate_lines</span>=1
    <span class="org-builtin">local</span> <span class="org-variable-name">eps_file</span>=
    <span class="org-builtin">local</span> <span class="org-variable-name">parse_switch</span>=1

    <span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">""</span> ]]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Usage: eps2tikz [-option] [eps files ...]"</span>
        <span class="org-builtin">echo</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Options:"</span>
        <span class="org-builtin">echo</span> <span class="org-string">"    -k, --keep-xfig : Keep the intermediate xfig file."</span>
        <span class="org-builtin">echo</span>
    <span class="org-keyword">fi</span>

    <span class="org-keyword">while</span> [ -n <span class="org-string">"$1"</span> ]; <span class="org-keyword">do</span>
        <span class="org-variable-name">token</span>=<span class="org-string">"$1"</span>
        <span class="org-keyword">if</span> [[ <span class="org-string">"${token[1]}"</span> = <span class="org-string">"-"</span> ]]; <span class="org-keyword">then</span>
            <span class="org-variable-name">opt</span>=${<span class="org-variable-name">token</span>}
            <span class="org-keyword">if</span> [[ ${<span class="org-variable-name">parse_switch</span>} -eq 0 ]]; <span class="org-keyword">then</span>
                <span class="org-keyword">break</span>
            <span class="org-keyword">fi</span>
            <span class="org-keyword">if</span> [ <span class="org-string">"${opt}"</span> = <span class="org-string">"--keep-xfig"</span> ]; <span class="org-keyword">then</span>
                <span class="org-variable-name">keep_xfig</span>=1
            <span class="org-keyword">elif</span> [ <span class="org-string">"${opt}"</span> = <span class="org-string">"--do-not-remove-duplicate-lines"</span> ]; <span class="org-keyword">then</span>
                <span class="org-variable-name">remove_duplicate_lines</span>=0
            <span class="org-keyword">else</span>
                pkgtools__msg_warning <span class="org-string">"Ignoring option '${opt}' !"</span>
            <span class="org-keyword">fi</span>
        <span class="org-keyword">else</span>
            <span class="org-variable-name">arg</span>=${<span class="org-variable-name">token</span>}
            <span class="org-variable-name">parse_switch</span>=0
            <span class="org-keyword">if</span> [ <span class="org-string">"${arg##*.}"</span> = <span class="org-string">"eps"</span> ]; <span class="org-keyword">then</span>
                <span class="org-variable-name">eps_file</span>=<span class="org-string">"${eps_file} ${arg}"</span>
            <span class="org-keyword">else</span>
                pkgtools__msg_warning <span class="org-string">"'${eps_file}' is not an Encapsulated PostScript"</span>
            <span class="org-keyword">fi</span>
        <span class="org-keyword">fi</span>
        <span class="org-builtin">shift</span>
    <span class="org-keyword">done</span>

    <span class="org-keyword">if</span> [[ -z <span class="org-string">"${eps_file}"</span> ]]; <span class="org-keyword">then</span>
        pkgtools__msg_error <span class="org-string">"Missing EPS file !"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>

    <span class="org-keyword">for</span> i<span class="org-keyword"> in</span> $(<span class="org-builtin">echo</span> ${<span class="org-variable-name">eps_file</span>}); <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -f <span class="org-string">"${i}"</span> ]; <span class="org-keyword">then</span>
            pkgtools__msg_warning <span class="org-string">"File ${i} does not exist! Skip it"</span>
            <span class="org-keyword">continue</span>
        <span class="org-keyword">fi</span>

        <span class="org-builtin">local</span> <span class="org-variable-name">fig_file</span>=${<span class="org-variable-name">i</span>/.eps/.fig}
        <span class="org-builtin">local</span> <span class="org-variable-name">tikz_file</span>=${<span class="org-variable-name">i</span>/.eps/.tikz}

        pkgtools__msg_notice <span class="org-string">"Converting ${i} file to ${tikz_file}..."</span>

        <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -x $(<span class="org-builtin">which</span> pstoedit) ]]; <span class="org-keyword">then</span>
            pkgtools__msg_error <span class="org-string">"Missing 'pstoedit' binary !"</span>
            __pkgtools__at_function_exit
            <span class="org-keyword">return</span> 1
        <span class="org-keyword">fi</span>
        pstoedit -f xfig <span class="org-string">"${i}"</span> &gt; ${<span class="org-variable-name">fig_file</span>} 2&gt; /dev/null

        <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -x $(<span class="org-builtin">which</span> fig2tikz) ]]; <span class="org-keyword">then</span>
            pkgtools__msg_error <span class="org-string">"Missing fig2tikz' binary !"</span>
            __pkgtools__at_function_exit
            <span class="org-keyword">return</span> 1
        <span class="org-keyword">fi</span>
        fig2tikz ${<span class="org-variable-name">fig_file</span>} &gt; ${<span class="org-variable-name">tikz_file</span>}.tmp
        <span class="org-keyword">if</span> [[ ${<span class="org-variable-name">remove_duplicate_lines</span>} -eq 1 ]]; <span class="org-keyword">then</span>
            pkgtools__msg_notice <span class="org-string">"Remove duplicate lines..."</span>
            awk <span class="org-string">'{if (match($0,"definecolor") || !seen[$0]++) {print $0}}'</span> ${<span class="org-variable-name">tikz_file</span>}.tmp &gt; ${<span class="org-variable-name">tikz_file</span>}
        <span class="org-keyword">else</span>
            cp ${<span class="org-variable-name">tikz_file</span>}.tmp ${<span class="org-variable-name">tikz_file</span>}
        <span class="org-keyword">fi</span>

        rm -f ${<span class="org-variable-name">tikz_file</span>}.tmp

        <span class="org-keyword">if</span> [[ ${<span class="org-variable-name">keep_xfig</span>} -eq 0 ]]; <span class="org-keyword">then</span>
            rm -f ${<span class="org-variable-name">fig_file</span>}
        <span class="org-keyword">fi</span>

    <span class="org-keyword">done</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}

<span class="org-comment-delimiter"># </span><span class="org-comment">Connect completion system</span>
compdef _eps2tikz eps2tikz

<span class="org-keyword">function</span> <span class="org-function-name">_eps2tikz</span> ()
{
    _arguments -C                                                                             <span class="org-sh-escaped-newline">\</span>
        <span class="org-string">'(-v --verbose)'</span>{-v,--verbose}<span class="org-string">'[verbose output]'</span>                                      <span class="org-sh-escaped-newline">\</span>
        <span class="org-string">'(-h --help)'</span>{-h,--help}<span class="org-string">'[print help message]'</span>                                        <span class="org-sh-escaped-newline">\</span>
        --keep-xfig<span class="org-string">'[Keep Xfig files]'</span>                                                        <span class="org-sh-escaped-newline">\</span>
        --do-not-remove-duplicate-lines<span class="org-string">'[do not edit tikz file by removing duplicated lines]'</span> <span class="org-sh-escaped-newline">\</span>
        <span class="org-string">"*:filename: _alternative 'files:file:_files -g  \"*.eps\"'"</span> &amp;&amp; <span class="org-variable-name">ret</span>=0
}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-21" class="outline-4">
<h4 id="unnumbered-21">Grab point with <code>dexter</code></h4>
<div class="outline-text-4" id="text-unnumbered-21">
<p>
<a href="http://sourceforge.net/projects/dexter/">Dexter</a> is a little java program to interactively or semi-automatically extract
data from scanned graphs. In its applet incarnation it is used by the
Astrophysics Data System.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">dexter</span> ()
{
    __pkgtools__at_function_enter dexter
    <span class="org-keyword">if</span> [[ <span class="org-string">"$1"</span> == <span class="org-string">""</span> ]]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Usage: dexter [image files ...]"</span>
        <span class="org-builtin">echo</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">else</span>
        java -jar /home/garrido/Workdir/Development/java/dexter/Debuxter.jar $<span class="org-variable-name">1</span>
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-22" class="outline-3">
<h3 id="unnumbered-22">Mounting/unmounting USB drives</h3>
<div class="outline-text-3" id="text-unnumbered-22">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">usb_umount</span> ()
{
    <span class="org-keyword">for</span> d<span class="org-keyword"> in</span> /media/*; <span class="org-keyword">do</span>
        sudo umount $<span class="org-variable-name">d</span>
    <span class="org-keyword">done</span>
    sudo modprobe usb_storage
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-23" class="outline-3">
<h3 id="unnumbered-23">Subversion functions</h3>
<div class="outline-text-3" id="text-unnumbered-23">
</div><div id="outline-container-unnumbered-24" class="outline-4">
<h4 id="unnumbered-24">Better SVN status</h4>
<div class="outline-text-4" id="text-unnumbered-24">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">svnstatus</span> ()
{
    __pkgtools__at_function_enter svnstatus
    <span class="org-variable-name">templist</span>=$(svn status $<span class="org-variable-name">*</span>)
    <span class="org-builtin">echo</span> <span class="org-string">"$(echo $templist | grep '^?' | wc -l) unversioned files/directories"</span>
    <span class="org-builtin">echo</span> $<span class="org-variable-name">templist</span> | grep -v <span class="org-string">'^?'</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-25" class="outline-4">
<h4 id="unnumbered-25">Better SVN diff (needs code2color)</h4>
<div class="outline-text-4" id="text-unnumbered-25">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">svndiff</span> ()
{
    __pkgtools__at_function_enter svndiff
    svn diff $<span class="org-variable-name">*</span> | code2color -l patch -
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-unnumbered-26" class="outline-3">
<h3 id="unnumbered-26">Better <code>ls</code> with <code>git</code> support</h3>
<div class="outline-text-3" id="text-unnumbered-26">
<p>
Original work done by <a href="https://github.com/supercrabtree/k">supercrabtree</a>
</p>

<div class="org-src-container">

<pre class="src src-sh">zmodload zsh/datetime
zmodload -F zsh/stat b:zstat

<span class="org-function-name">k</span> () {
    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Setup</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Stop stat failing when a directory contains either no files or no hidden files</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Track if we _accidentally_ create a new global variable</span>
    <span class="org-builtin">setopt</span> local_options null_glob warn_create_global

    <span class="org-comment-delimiter"># </span><span class="org-comment">Turn on 256 colour terminal, not sure this works at all.</span>
    <span class="org-builtin">typeset</span> <span class="org-variable-name">OLD_TERM</span>=<span class="org-string">"$TERM"</span>
    <span class="org-variable-name">TERM</span>=<span class="org-string">'xterm-256color'</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Vars</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>

    <span class="org-builtin">typeset</span> -a MAX_LEN A RESULTS STAT_RESULTS
    <span class="org-builtin">typeset</span> TOTAL_BLOCKS

    <span class="org-comment-delimiter"># </span><span class="org-comment">Get now</span>
    <span class="org-builtin">typeset</span> <span class="org-variable-name">K_EPOCH</span>=<span class="org-string">"${EPOCHSECONDS:?}"</span>

    <span class="org-builtin">typeset</span> -i <span class="org-variable-name">TOTAL_BLOCKS</span>=0

    <span class="org-variable-name">MAX_LEN</span>=(0 0 0 0 0 0)

    <span class="org-comment-delimiter"># </span><span class="org-comment">Array to hold results from `stat` call</span>
    <span class="org-variable-name">RESULTS</span>=()

    <span class="org-comment-delimiter"># </span><span class="org-comment">only set once so must be out of the main loop</span>
    <span class="org-builtin">typeset</span> -i <span class="org-variable-name">IS_GIT_REPO</span>=0

    <span class="org-builtin">typeset</span> -i <span class="org-variable-name">LARGE_FILE_COLOR</span>=196
    <span class="org-builtin">typeset</span> -a SIZELIMITS_TO_COLOR
    <span class="org-comment-delimiter"># </span><span class="org-comment">SIZELIMITS_TO_COLOR=(</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">1024  46    # &lt;= 1kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">2048  82    # &lt;= 2kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">3072  118   # &lt;= 3kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">5120  154   # &lt;= 5kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">10240  190   # &lt;= 10kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">20480  226   # &lt;= 20kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">40960  220   # &lt;= 40kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">102400  214   # &lt;= 100kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">262144  208   # &lt;= 0.25mb || 256kb</span>
    <span class="org-comment-delimiter">#     </span><span class="org-comment">524288  202   # &lt;= 0.5mb || 512kb</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">)</span>
    <span class="org-variable-name">SIZELIMITS_TO_COLOR</span>=(
        1024   226    <span class="org-comment-delimiter"># </span><span class="org-comment">&lt;= 1kb</span>
        2048   220    <span class="org-comment-delimiter"># </span><span class="org-comment">&lt;= 2kb</span>
        5120   214   <span class="org-comment-delimiter"># </span><span class="org-comment">&lt;= 5kb</span>
        524288  208   <span class="org-comment-delimiter"># </span><span class="org-comment">&lt;= 512kb</span>
        1024000  202   <span class="org-comment-delimiter"># </span><span class="org-comment">&lt;= 1Mb</span>
    )
    <span class="org-builtin">typeset</span> -i <span class="org-variable-name">ANCIENT_TIME_COLOR</span>=252  <span class="org-comment-delimiter"># </span><span class="org-comment">&gt; more than 2 years old</span>
    <span class="org-builtin">typeset</span> -a FILEAGES_TO_COLOR
    <span class="org-variable-name">FILEAGES_TO_COLOR</span>=(
        0 196  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; in the future, #spooky</span>
        60 236  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than a min old</span>
        3600 238  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than an hour old</span>
        86400 240  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than 1 day old</span>
        604800 242  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than 1 week old</span>
        2419200 244  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than 28 days (4 weeks) old</span>
        15724800 244  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than 26 weeks (6 months) old</span>
        31449600 250  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than 1 year old</span>
        62899200 252  <span class="org-comment-delimiter"># </span><span class="org-comment">&lt; less than 2 years old</span>
    )

    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Stat call to get directory listing</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Break total blocks of the front of the stat call, then push the rest to results</span>
    <span class="org-builtin">typeset</span> -i <span class="org-variable-name">i</span>=1 <span class="org-variable-name">j</span>=1 <span class="org-variable-name">k</span>=1
    <span class="org-builtin">typeset</span> -a STATS_PARAMS_LIST
    <span class="org-builtin">typeset</span> fn statvar
    <span class="org-builtin">typeset</span> -A sv

    <span class="org-comment-delimiter"># </span><span class="org-comment">for fn in . .. *(D)</span>
    <span class="org-keyword">for</span> fn<span class="org-keyword"> in</span> $(command \ls -rt $<span class="org-variable-name">@</span>)
    <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [[ $<span class="org-variable-name">fn</span> == <span class="org-string">"."</span> || $<span class="org-variable-name">fn</span> == <span class="org-string">".."</span> ]]; <span class="org-keyword">then continue</span>; <span class="org-keyword">fi</span>
        <span class="org-variable-name">statvar</span>=<span class="org-string">"stats_$i"</span>
        <span class="org-builtin">typeset</span> -A $<span class="org-variable-name">statvar</span>
        zstat -H $<span class="org-variable-name">statvar</span> -Lsn -F <span class="org-string">"%s^%d^%b^%H:%M^%Y"</span> -- <span class="org-string">"$fn"</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">use lstat, render mode/uid/gid to strings</span>
        <span class="org-variable-name">STATS_PARAMS_LIST</span>+=($<span class="org-variable-name">statvar</span>)
        <span class="org-variable-name">i</span>+=1
    <span class="org-keyword">done</span>


    <span class="org-comment-delimiter"># </span><span class="org-comment">On each result calculate padding by getting max length on each array member</span>
    <span class="org-keyword">for</span> statvar<span class="org-keyword"> in</span> <span class="org-string">"${STATS_PARAMS_LIST[@]}"</span>
    <span class="org-keyword">do</span>
        <span class="org-variable-name">sv</span>=(<span class="org-string">"${(@Pkv)statvar}"</span>)
        <span class="org-keyword">if</span> [[ ${#<span class="org-variable-name">sv</span>[mode]}  -gt $<span class="org-variable-name">MAX_LEN</span>[1] ]]; <span class="org-keyword">then</span> MAX_LEN[1]=${#<span class="org-variable-name">sv</span>[mode]}  ; <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> [[ ${#<span class="org-variable-name">sv</span>[nlink]} -gt $<span class="org-variable-name">MAX_LEN</span>[2] ]]; <span class="org-keyword">then</span> MAX_LEN[2]=${#<span class="org-variable-name">sv</span>[nlink]} ; <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> [[ ${#<span class="org-variable-name">sv</span>[uid]}   -gt $<span class="org-variable-name">MAX_LEN</span>[3] ]]; <span class="org-keyword">then</span> MAX_LEN[3]=${#<span class="org-variable-name">sv</span>[uid]}   ; <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> [[ ${#<span class="org-variable-name">sv</span>[gid]}   -gt $<span class="org-variable-name">MAX_LEN</span>[4] ]]; <span class="org-keyword">then</span> MAX_LEN[4]=${#<span class="org-variable-name">sv</span>[gid]}   ; <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> [[ ${#<span class="org-variable-name">sv</span>[size]}  -gt $<span class="org-variable-name">MAX_LEN</span>[5] ]]; <span class="org-keyword">then</span> MAX_LEN[5]=${#<span class="org-variable-name">sv</span>[size]}  ; <span class="org-keyword">fi</span>
        <span class="org-variable-name">TOTAL_BLOCKS</span>+=$<span class="org-variable-name">sv</span>[blocks]
    <span class="org-keyword">done</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">Print total block before listing</span>
    <span class="org-builtin">echo</span> <span class="org-string">"total $TOTAL_BLOCKS"</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Loop through each line of stat, pad where appropriate and do git dirty checking</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">----------------------------------------------------------------------------</span>

    <span class="org-builtin">typeset</span> REPOMARKER
    <span class="org-builtin">typeset</span> PERMISSIONS HARDLINKCOUNT OWNER GROUP FILESIZE DATE NAME SYMLINK_TARGET
    <span class="org-builtin">typeset</span> FILETYPE PER1 PER2 PER3 PERMISSIONS_OUTPUT STATUS
    <span class="org-builtin">typeset</span> TIME_DIFF TIME_COLOR DATE_OUTPUT
    <span class="org-builtin">typeset</span> -i IS_DIRECTORY IS_SYMLINK IS_EXECUTABLE
    <span class="org-builtin">typeset</span> -i COLOR

    <span class="org-variable-name">k</span>=1
    <span class="org-keyword">for</span> statvar<span class="org-keyword"> in</span> <span class="org-string">"${STATS_PARAMS_LIST[@]}"</span>
    <span class="org-keyword">do</span>
        <span class="org-variable-name">sv</span>=(<span class="org-string">"${(@Pkv)statvar}"</span>)

        <span class="org-comment-delimiter"># </span><span class="org-comment">We check if the result is a git repo later, so set a blank marker indication the result is not a git repo</span>
        <span class="org-variable-name">REPOMARKER</span>=<span class="org-string">""</span>
        <span class="org-variable-name">IS_DIRECTORY</span>=0
        <span class="org-variable-name">IS_SYMLINK</span>=0
        <span class="org-variable-name">IS_EXECUTABLE</span>=0

        <span class="org-variable-name">PERMISSIONS</span>=<span class="org-string">"${sv[mode]}"</span>
        <span class="org-variable-name">HARDLINKCOUNT</span>=<span class="org-string">"${sv[nlink]}"</span>
        <span class="org-variable-name">OWNER</span>=<span class="org-string">"${sv[uid]}"</span>
        <span class="org-variable-name">GROUP</span>=<span class="org-string">"${sv[gid]}"</span>
        <span class="org-variable-name">FILESIZE</span>=<span class="org-string">"${sv[size]}"</span>
        <span class="org-variable-name">DATE</span>=(${(s:^:)sv[mtime]}) <span class="org-comment-delimiter"># </span><span class="org-comment">Split date on ^</span>
        <span class="org-variable-name">NAME</span>=<span class="org-string">"${sv[name]}"</span>
        <span class="org-variable-name">SYMLINK_TARGET</span>=<span class="org-string">"${sv[link]}"</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Check for file types</span>
        <span class="org-keyword">if</span> [[ -d <span class="org-string">"$NAME"</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">IS_DIRECTORY</span>=1; <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> [[ -L <span class="org-string">"$NAME"</span> ]]; <span class="org-keyword">then</span>   <span class="org-variable-name">IS_SYMLINK</span>=1; <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">is this a git repo</span>
        <span class="org-keyword">if</span> [[ $<span class="org-variable-name">k</span> == 1 &amp;&amp; $(command git rev-parse --is-inside-work-tree 2&gt;/dev/null) == true ]]
        <span class="org-keyword">then</span>
            <span class="org-variable-name">IS_GIT_REPO</span>=1
        <span class="org-keyword">fi</span>;

        <span class="org-comment-delimiter"># </span><span class="org-comment">Pad so all the lines align - firstline gets padded the other way</span>
        <span class="org-variable-name">PERMISSIONS</span>=<span class="org-string">"${(r:MAX_LEN[1]:)PERMISSIONS}"</span>
        <span class="org-variable-name">HARDLINKCOUNT</span>=<span class="org-string">"${(l:MAX_LEN[2]:)HARDLINKCOUNT}"</span>
        <span class="org-variable-name">OWNER</span>=<span class="org-string">"${(l:MAX_LEN[3]:)OWNER}"</span>
        <span class="org-variable-name">GROUP</span>=<span class="org-string">"${(l:MAX_LEN[4]:)GROUP}"</span>
        <span class="org-variable-name">FILESIZE</span>=<span class="org-string">"${(l:MAX_LEN[5]:)FILESIZE}"</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour the permissions - TODO</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour the first character based on filetype</span>
        <span class="org-variable-name">FILETYPE</span>=<span class="org-string">"${PERMISSIONS[1]}"</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">if (( IS_DIRECTORY ))</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">then</span>
        <span class="org-comment-delimiter">#     </span><span class="org-comment">FILETYPE=${FILETYPE//d/$'\e[01;38;5;004m'd$'\e[0m'};</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">elif (( IS_SYMLINK ))</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">then</span>
        <span class="org-comment-delimiter">#     </span><span class="org-comment">FILETYPE=${FILETYPE//l/$'\e[0;35m'l$'\e[0m'};</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">elif [[ $FILETYPE == "-" ]];</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">then</span>
        <span class="org-comment-delimiter">#     </span><span class="org-comment">FILETYPE=${FILETYPE//-/$'\e[0;37m'-$'\e[0m'};</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Permissions Owner</span>
        <span class="org-variable-name">PER1</span>=<span class="org-string">"${PERMISSIONS[2,4]}"</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Permissions Group</span>
        <span class="org-variable-name">PER2</span>=<span class="org-string">"${PERMISSIONS[5,7]}"</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Permissions User</span>
        <span class="org-variable-name">PER3</span>=<span class="org-string">"${PERMISSIONS[8,10]}"</span>

        <span class="org-variable-name">PERMISSIONS_OUTPUT</span>=<span class="org-string">"$FILETYPE$PER1$PER2$PER3"</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--x --x --x warning</span>
        <span class="org-keyword">if</span> [[ $<span class="org-variable-name">PER1</span>[3] == <span class="org-string">"x"</span> || $<span class="org-variable-name">PER2</span>[3] == <span class="org-string">"x"</span> || $<span class="org-variable-name">PER3</span>[3] == <span class="org-string">"x"</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">IS_EXECUTABLE</span>=1; <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--- --- rwx warning</span>
        <span class="org-keyword">if</span> [[ $<span class="org-variable-name">PER3</span> == <span class="org-string">"rwx"</span> &amp;&amp; <span class="org-negation-char">!</span> IS_SYMLINK ]]; <span class="org-keyword">then</span> <span class="org-variable-name">PERMISSIONS_OUTPUT</span>=$<span class="org-string">'\e[30;41m'"$PERMISSIONS"</span>$<span class="org-string">'\e[0m'</span>; <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour the symlinks - TODO</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour Owner and Group</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">OWNER=$'\e[38;5;011m'"$OWNER"$'\e[0m'</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">GROUP=$'\e[38;5;009m'"$GROUP"$'\e[0m'</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour file weights</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-variable-name">COLOR</span>=LARGE_FILE_COLOR
        <span class="org-keyword">for</span> i j<span class="org-keyword"> in</span> ${<span class="org-variable-name">SIZELIMITS_TO_COLOR</span>[@]}
        <span class="org-keyword">do</span>
            (( FILESIZE &lt;= i )) || <span class="org-keyword">continue</span>
            <span class="org-variable-name">COLOR</span>=$<span class="org-variable-name">j</span>
            <span class="org-keyword">break</span>
        <span class="org-keyword">done</span>

        <span class="org-variable-name">FILESIZE</span>=<span class="org-string">"$(command numfmt --to=si --format="%4f" $FILESIZE)"</span>
        <span class="org-variable-name">FILESIZE</span>=$<span class="org-string">'\e[38;5;'"${COLOR}m$FILESIZE"</span>$<span class="org-string">'\e[0m'</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour the date and time based on age, then format for output</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Setup colours based on time difference</span>
        <span class="org-variable-name">TIME_DIFF</span>=$(( K_EPOCH - DATE[1] ))
        <span class="org-variable-name">TIME_COLOR</span>=$<span class="org-variable-name">ANCIENT_TIME_COLOR</span>
        <span class="org-keyword">for</span> i j<span class="org-keyword"> in</span> ${<span class="org-variable-name">FILEAGES_TO_COLOR</span>[@]}
        <span class="org-keyword">do</span>
            (( TIME_DIFF &lt; i )) || <span class="org-keyword">continue</span>
            <span class="org-variable-name">TIME_COLOR</span>=$<span class="org-variable-name">j</span>
            <span class="org-keyword">break</span>
        <span class="org-keyword">done</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">Format date to show year if more than 6 months since last modified</span>
        <span class="org-keyword">if</span> (( TIME_DIFF &lt; 15724800 )); <span class="org-keyword">then</span>
            <span class="org-variable-name">DATE_OUTPUT</span>=<span class="org-string">"${DATE[2]} ${(r:5:: :)${DATE[3][0,5]}} ${DATE[4]}"</span>
        <span class="org-keyword">else</span>
            <span class="org-variable-name">DATE_OUTPUT</span>=<span class="org-string">"${DATE[2]} ${(r:6:: :)${DATE[3][0,5]}} ${DATE[5]}"</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">extra space; 4 digit year instead of 5 digit HH:MM</span>
        <span class="org-keyword">fi</span>;
        <span class="org-variable-name">DATE_OUTPUT</span>[1]=<span class="org-string">"${DATE_OUTPUT[1]//0/ }"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">If day of month begins with zero, replace zero with space</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment"># Apply colour to formated date</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">DATE_OUTPUT=$'\e[38;5;'"${TIME_COLOR}m${DATE_OUTPUT}"$'\e[0m'</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour the repomarker</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment"># Check for git repo, first checking if the result is a directory</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">if (( IS_GIT_REPO == 0)) || (( k &lt;= 2 ))</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">then</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">if (( IS_DIRECTORY )) &amp;&amp; [[ -d "$NAME/.git" ]]</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">then</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">if command git --git-dir="$PWD/$NAME/.git" --work-tree="$PWD/$NAME" diff --quiet --ignore-submodules HEAD &amp;&gt;/dev/null # if dirty</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">then REPOMARKER=$'\e[38;5;46m|\e[0m' # Show a green vertical bar for dirty</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">else REPOMARKER=$'\e[0;31m|\e[0m' # Show a red vertical bar if clean</span>
            <span class="org-comment-delimiter">#     </span><span class="org-comment">fi</span>
            <span class="org-comment-delimiter"># </span><span class="org-comment">fi</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">fi</span>

        <span class="org-keyword">if</span> (( IS_GIT_REPO )) &amp;&amp; (( k &gt; 0 )) &amp;&amp; [[ <span class="org-string">"$NAME"</span> != <span class="org-string">'.git'</span> ]]
        <span class="org-keyword">then</span>
            <span class="org-variable-name">STATUS</span>=<span class="org-string">"$(command git status --porcelain --ignored --untracked-files=normal "$NAME")"</span>
            <span class="org-variable-name">STATUS</span>=<span class="org-string">"${STATUS[1,2]}"</span>
            <span class="org-keyword">if</span> [[ $<span class="org-variable-name">STATUS</span> == <span class="org-string">' M'</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">REPOMARKER</span>=$<span class="org-string">'\e[01;38;5;001m&#10008;\e[0m'</span>; <span class="org-comment-delimiter"># </span><span class="org-comment">Modified</span>
            <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">STATUS</span> == <span class="org-string">'??'</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">REPOMARKER</span>=$<span class="org-string">'\e[01;38;5;009m&#9873;\e[0m'</span>; <span class="org-comment-delimiter"># </span><span class="org-comment">Untracked</span>
            <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">STATUS</span> == <span class="org-string">'!!'</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">REPOMARKER</span>=$<span class="org-string">'\e[01;38;5;004m&#9872;\e[0m'</span>; <span class="org-comment-delimiter"># </span><span class="org-comment">Ignored</span>
            <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">STATUS</span> == <span class="org-string">'A '</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">REPOMARKER</span>=$<span class="org-string">'\e[01;38;5;093m|\e[0m'</span>; <span class="org-comment-delimiter"># </span><span class="org-comment">Added</span>
            <span class="org-keyword">else</span>                             <span class="org-variable-name">REPOMARKER</span>=$<span class="org-string">'\e[01;38;5;002m&#10004;\e[0m'</span>; <span class="org-comment-delimiter"># </span><span class="org-comment">Good</span>
            <span class="org-keyword">fi</span>
        <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Colour the filename</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Unfortunately, the choices for quoting which escape ANSI color sequences are q &amp; qqqq; none of q- qq qqq work.</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">But we don't want to quote '.'; so instead we escape the escape manually and use q-</span>
        <span class="org-variable-name">NAME</span>=<span class="org-string">"${(q-)NAME//$'\e'/\\e}"</span>    <span class="org-comment-delimiter"># </span><span class="org-comment">also propagate changes to SYMLINK_TARGET below</span>

        <span class="org-keyword">if</span> (( IS_SYMLINK ))
        <span class="org-keyword">then</span>
            <span class="org-variable-name">NAME</span>=$<span class="org-string">'\e[07;38;5;4m'"$NAME"</span>$<span class="org-string">'\e[0m'</span>
        <span class="org-keyword">elif</span> (( IS_DIRECTORY ))
        <span class="org-keyword">then</span>
            <span class="org-variable-name">NAME</span>=$<span class="org-string">'\e[01;38;5;4m'"$NAME"</span>$<span class="org-string">'\e[0m'</span>
        <span class="org-keyword">fi</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Format symlink target</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-keyword">if</span> [[ $<span class="org-variable-name">SYMLINK_TARGET</span> != <span class="org-string">""</span> ]]; <span class="org-keyword">then</span> <span class="org-variable-name">SYMLINK_TARGET</span>=<span class="org-string">"-&gt; ${(q-)SYMLINK_TARGET//$'\e'/\\e}"</span>; <span class="org-keyword">fi</span>
        <span class="org-comment-delimiter">#</span><span class="org-comment">SYMLINK_TARGET=$'\e[38;5;27m'"$SYMLINK_TARGET"$'\e[0m'</span>

        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">Display final result</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">--------------------------------------------------------------------------</span>
        <span class="org-builtin">print</span> -r -- <span class="org-string">"$PERMISSIONS_OUTPUT $HARDLINKCOUNT $OWNER $GROUP $FILESIZE $DATE_OUTPUT $REPOMARKER $NAME $SYMLINK_TARGET"</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">print -r -- "$FILESIZE $DATE_OUTPUT $REPOMARKER $NAME $SYMLINK_TARGET"</span>

        <span class="org-variable-name">k</span>=$((k+1)) <span class="org-comment-delimiter"># </span><span class="org-comment">Bump loop index</span>
    <span class="org-keyword">done</span>

    <span class="org-comment-delimiter"># </span><span class="org-comment">cleanup / recovery</span>
    <span class="org-variable-name">TERM</span>=<span class="org-string">"$OLD_TERM"</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">http://upload.wikimedia.org/wikipedia/en/1/15/Xterm_256color_chart.svg</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-27" class="outline-3">
<h3 id="unnumbered-27">Better <code>tree</code> with <code>git</code> support</h3>
<div class="outline-text-3" id="text-unnumbered-27">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">t</span>()
{
    <span class="org-variable-name">skip_ignore_files</span>=0
    <span class="org-keyword">if</span> [[ $<span class="org-variable-name">@</span> == *--skip-ignore-files* ]]; <span class="org-keyword">then</span>
        <span class="org-variable-name">skip_ignore_files</span>=1
        <span class="org-variable-name">arguments</span>=${<span class="org-variable-name">@</span>/--skip-ignore-files/}
    <span class="org-keyword">fi</span>
    tree -ft $<span class="org-variable-name">arguments</span> | awk -v <span class="org-variable-name">skip_ignore_files</span>=$<span class="org-variable-name">skip_ignore_files</span> <span class="org-string">'{</span>
<span class="org-string">  status=""</span>
<span class="org-string">  marker=" "</span>
<span class="org-string">  color="\033[0m"</span>
<span class="org-string">  # if (system("test -f " $NF) == 0) print "file="$NF</span>
<span class="org-string">  if (system("test -d " $NF) == 0) {</span>
<span class="org-string">      is_git_repo=system("git rev-parse --is-inside-work-tree &gt; /dev/null 2&gt;&amp;1")</span>
<span class="org-string">      color="\033[01;38;5;004m"</span>
<span class="org-string">      marker=""</span>
<span class="org-string">  }</span>
<span class="org-string">  if (is_git_repo == 0) {</span>
<span class="org-string">      cmd = "git status --porcelain --ignored --untracked-files=normal \"" $NF "\""</span>
<span class="org-string">      cmd | getline status</span>
<span class="org-string">      status=substr(status,1,2)</span>
<span class="org-string">      if (status == " M") {</span>
<span class="org-string">          color="\033[38;5;001m"</span>
<span class="org-string">          marker="&#10008; "</span>
<span class="org-string">      } else if (status == "??") {</span>
<span class="org-string">          color="\033[38;5;009m"</span>
<span class="org-string">          marker="&#9873; "</span>
<span class="org-string">      } else if (status == "!!") {</span>
<span class="org-string">          color="\033[38;5;004m"</span>
<span class="org-string">          marker=color "&#9872; "</span>
<span class="org-string">          if (skip_ignore_files) next</span>
<span class="org-string">      } else if (status == "A ") {</span>
<span class="org-string">          color="\033[38;5;093m"</span>
<span class="org-string">          marker="| "</span>
<span class="org-string">      } else {</span>
<span class="org-string">          color="\033[38;5;002m"</span>
<span class="org-string">          marker="&#10004; "</span>
<span class="org-string">      }</span>
<span class="org-string">  }</span>
<span class="org-string">  basefile=$NF</span>
<span class="org-string">  sub(".*/",color marker,basefile)</span>
<span class="org-string">  sub($NF,basefile,$0)</span>

<span class="org-string">  print $0 "\033[0m"</span>
<span class="org-string">    }'</span>
}
<span class="org-builtin">alias</span> <span class="org-variable-name">tt</span>=<span class="org-string">'t -L 1'</span>
<span class="org-builtin">alias</span> <span class="org-variable-name">ta</span>=<span class="org-string">'t -a -L 1'</span>
<span class="org-builtin">alias</span> <span class="org-variable-name">ti</span>=<span class="org-string">'t --skip-ignore-files'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-28" class="outline-3">
<h3 id="unnumbered-28">Misc.</h3>
<div class="outline-text-3" id="text-unnumbered-28">
</div><div id="outline-container-unnumbered-29" class="outline-4">
<h4 id="unnumbered-29">Grabbing video from mms link</h4>
<div class="outline-text-4" id="text-unnumbered-29">
<div class="org-src-container">

<pre class="src src-sh"><span class="org-keyword">function</span> <span class="org-function-name">grab_video</span> ()
{
    __pkgtools__at_function_enter grab_video
    <span class="org-keyword">if</span> [[ <span class="org-negation-char">!</span> -z $<span class="org-variable-name">1</span> ]] ; <span class="org-keyword">then</span>
        pkgtools__msg_notice <span class="org-string">"Grabing video from $1 link and saving it to /tmp/dump_video.avi..."</span>
        mplayer -dumpstream <span class="org-string">"$1"</span> -dumpfile /tmp/dump_video.avi
    <span class="org-keyword">else</span>
        pkgtools__msg_error <span class="org-string">"Missing mms link !"</span>
        __pkgtools__at_function_exit
        <span class="org-keyword">return</span> 1
    <span class="org-keyword">fi</span>
    __pkgtools__at_function_exit
    <span class="org-keyword">return</span> 0
}
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
File under <i class="fa fa-github-alt"></i> version control - commit <a href="https://github.com/xgarrido/zsh-utilities/commit/b7f7874ac2e22ead7c0cd912dec7d91f04df1951">b7f7874</a> - 2014-11-07
</div>
</body>
</html>
